@using Geneta.Simulation
@using Radzen.Blazor
<h3>Configuration</h3>

<EditForm Model="@Model" OnValidSubmit="@Save">

    <div class="traits-selection">
        @foreach (Traits trait in Enum.GetValues<Traits>())
        {
            @if (trait != 0)
            {
                <div class="trait-config-row">
                    <RadzenCheckBox Value="@IsTraitSelected(trait)" 
                                    Change="@((bool val) => OnTraitSelectionChanged(trait, val))" />
                    <span>@trait</span>
            
                    @if (IsTraitSelected(trait))
                    {
                        <RadzenDropDown Data="@strategyOptions"
                                        Value="@(GetStrategyForTrait(trait))"
                                        ValueChanged="@((PhenoStrategyType val)
                                                          => SetStrategyForTrait(trait, val))"
                                        TextProperty="Text"
                                        ValueProperty="Value"
                                        Style="width: 200px"/>
                    }
                </div>

            }
        }
    </div>
    
    <div class="amount-selection">
        <div>
            Amount of Children
        </div>
        @Model.Amount.First()
        <RadzenSlider @bind-Value=@Model.Amount TValue="IEnumerable<int>"
                      Range="true"
                      Min="2"
                      Max="60"
                      Step="1"/>
        @Model.Amount.Last()
    </div>
    
    <button type="submit" class="btn btn-primary">Save</button>
</EditForm>

@code {
    private bool IsTraitSelected(Traits trait)
    {
        return Model.SelectedTraits.HasFlag(trait);
    }

    private void OnTraitSelectionChanged(Traits trait, bool selected)
    {
        if (selected)
        {
            Model.SelectedTraits |= trait;
            if (!Model.PhenoMapping.ContainsKey(trait))
            {
                Model.PhenoMapping[trait] = PhenoStrategyType.CompleteDominance; // default value
            }
        }
        else
        {
            Model.SelectedTraits &= ~trait;
            Model.PhenoMapping.Remove(trait);
        }
    }

    
    private class StrategyOption
    {
        public PhenoStrategyType Value { get; set; } = PhenoStrategyType.CompleteDominance;
        public string Text { get; set; } = "";
    }

    private StrategyOption[] strategyOptions = new[]
    {
        new StrategyOption { Value = PhenoStrategyType.CompleteDominance, Text = "Complete Dominance" },
        new StrategyOption { Value = PhenoStrategyType.IncompleteDominance, Text = "Incomplete Dominance" }
    };
    
    private PhenoStrategyType GetStrategyForTrait(Traits trait)
    {
        return Model.PhenoMapping[trait];
    }

    private void SetStrategyForTrait(Traits trait, PhenoStrategyType value)
    {
        Model.PhenoMapping[trait] = value;
    }

}

